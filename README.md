# Amazon-LMRRC

The [Amazon Last-Mile Routing Research Challenge](https://routingchallenge.mit.edu/) focuses on the gap between theoretical route planning and real-life route execution that most optimization-based approaches are unable to bridge. This gap relies on several factors that are difficult to model explicitly, such as geography, infrastructure, and consumers drivers deliver to. The goal of the challenge is to bridge this gap by exploiting a dataset of 6,112 historical routes operated by experienced drivers.

## How to download the data
You can use this code by simply cloning the repository. The dataset can be downloaded [here](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/UFOG2H), and once downloaded, the folder data must be located within the main directory of this repo. 

## Methodology
The proposed methodology has a two-level hierarchical structure. First, a zone (geographical region with multiple stops) sequence is found solving a Travelling Salesman Problem (TSP), then within each zone an open TSP (OTSP) is solved. The predicted route is the concatenation of the OTSP solutions. The learning process takes place in the definition of a cost matrix used in the TSP for the zone sequence:

<SPAN CLASS="typeset"><nobr><span class="scale"><span style="display:inline-block; width:17.774em"><span style="position:relative;"><span style="position:absolute; top:-0.805em; left:0em;"><span class="icmmi10">C</span><span style="position: relative; top:0.277em;"><span class="size2"><span class="icmmi10">i</span></span><span class="size2"><span class="icmmi10">j</span></span><span class="spacer" style="margin-left:0.040em"></span><span class="spacer" style="margin-left:0.05em"></span></span><span style="position: relative; margin-left:0.277em;"><span class="icmr10">=</span></span><span style="position: relative; margin-left:0.277em;"><span style="position: relative; top:-1.76em;"><img src="http://www.math.union.edu/~dpvc/jsmath/jsMath/fonts/cmex10/alpha/144/char28.png" style="height:61px; width:14px; vertical-align:-60px; margin-right:0.105em;" /></span><span style="display:inline-block; width:14.520em"><span style="position:relative;"><span style="position:absolute; top:0em; left:0em;"><span class="spacer" style="margin-left:0.166em"></span><span style="position:absolute; left:0.166em; top:-0.805em;"><img src="http://www.math.union.edu/~dpvc/jsmath/jsMath/fonts/cmr10/alpha/144/char0A.png" style=" width:14px; margin-right:0.021em;" /><span style="position: relative; top:0.277em;"><span class="size2"><span class="icmmi10">i</span></span><span class="size2"><span class="icmmi10">j</span></span><span class="spacer" style="margin-left:0.040em"></span><span class="spacer" style="margin-left:0.05em"></span></span><span class="icmmi10">T</span><span style="position: relative; top:0.277em;"><span class="size2"><span class="icmmi10">i</span></span><span class="size2"><span class="icmmi10">j</span></span><span class="spacer" style="margin-left:0.040em"></span><span class="spacer" style="margin-left:0.05em"></span></span><span style="position: relative; margin-left:0.222em;"><span class="icmr10">+</span></span><span style="position: relative; margin-left:0.222em;"><span class="icmr10">(</span></span><span class="icmr10">1</span><span style="position: relative; margin-left:0.222em;"><span class="icmsy10">&#x2212;</span></span><span style="position: relative; margin-left:0.222em;"><img src="http://www.math.union.edu/~dpvc/jsmath/jsMath/fonts/cmr10/alpha/144/char0A.png" style=" width:14px; margin-right:0.021em;" /><span style="position: relative; top:0.277em;"><span class="size2"><span class="icmmi10">i</span></span><span class="size2"><span class="icmmi10">j</span></span><span class="spacer" style="margin-left:0.040em"></span><span class="spacer" style="margin-left:0.05em"></span></span></span><span class="icmr10">)(1</span><span style="position: relative; margin-left:0.222em;"><span class="icmsy10">&#x2212;</span></span><span style="position: relative; margin-left:0.222em;"><span class="icmmi10">P</span><span style="position: relative; top:0.277em;"><span class="size2"><span class="icmmi10">i</span></span><span class="size2"><span class="icmmi10">j</span></span><span class="spacer" style="margin-left:0.040em"></span><span class="spacer" style="margin-left:0.05em"></span></span></span><span class="icmr10">)</span><img src="http://www.math.union.edu/~dpvc/jsmath/jsMath/fonts/cmmi10/alpha/144/char3B.png" style=" width:5px; vertical-align:-4px; margin-right:0.028em;" />&nbsp;</span><span style="position:absolute; left:0.166em; top:0.831em;"><span class="icmr10">0</span><img src="http://www.math.union.edu/~dpvc/jsmath/jsMath/fonts/cmmi10/alpha/144/char3B.png" style=" width:5px; vertical-align:-4px; margin-right:0.028em;" />&nbsp;</span><span style="position:absolute; left:11.382em; top:-0.805em;"><span style="position: relative; margin-left:1em;"><span class="icmmi10">i</span></span><span style="position: relative; margin-left:0.277em;"><span style="position: relative; margin-left:0.180em;"><img src="http://www.math.union.edu/~dpvc/jsmath/jsMath/fonts/cmmi10/alpha/144/char3D.png" style="height:20px; width:9px; vertical-align:-5px; margin-right:0.049em;" /></span><span class="spacer" style="margin-left:-0.729em"></span></span><span class="icmr10">=</span><span style="position: relative; margin-left:0.277em;"><span class="icmmi10">j</span></span><img src="http://www.math.union.edu/~dpvc/jsmath/jsMath/fonts/cmmi10/alpha/144/char3B.png" style=" width:5px; vertical-align:-4px; margin-right:0.028em;" />&nbsp;</span><span style="position:absolute; left:11.382em; top:0.831em;"><span style="position: relative; margin-left:1em;"><span class="icmmi10">i</span></span><span style="position: relative; margin-left:0.277em;"><span class="icmr10">=</span></span><span style="position: relative; margin-left:0.277em;"><span class="icmmi10">j</span></span><img src="http://www.math.union.edu/~dpvc/jsmath/jsMath/fonts/cmmi10/alpha/144/char3A.png" style=" width:4px; margin-right:0.078em;" />&nbsp;</span><span class="spacer" style="margin-left:0.166em"></span>&nbsp;</span><span class="blank" style="height:2.783em;vertical-align:-1.091em"></span></span></span><span class="spacer" style="margin-left:0.12em"></span></span>&nbsp;</span><span class="blank" style="height:0.886em;"></span></span></span><span class="blank" style="height:3.1em;vertical-align:-1.25em"></span></span></nobr></SPAN>


where $T_{ij}\in [0,1]$ is the normalized travel time from zone $i$ to zone $j$, and $P_{ij} \in [0,1]$ is the probability of going from zone $i$ to zone $j$. The probability matrix (P) is based on historical routes, and the more we see drivers going from zone $i$ to zone $j$, the higher $P_{ij}$ is. $\Omega$ is a weight which differs from station-to-zone, zone-to-zone, and zone-to-station.

Within each zone, an OTSP is solved including forcing the first node to be the last of the previous zone, and the last node to be close to the center of the next zone. This gives a sense of direction in the resolution of the problem.

We refer to our [paper]() for a detailed description of the methodology. 

## How the code is structured
The code is divided into three parts:
1. Model Build:  historical routes are used to define a probability matrix for the $zone$ TSP.
2. Model Apply: the cost matrix is used to determine the zone sequence by formulating a TSP over the zones including the station, and when the zone sequence has been established the stop sequence within each zone is determined by means of a series of OTSPs.
3. Model Score

The three main Python scripts: model_build.py, model_apply.py, and model_score.py require a Linux environment to be run. 
They must be run sequentially using the bash command in the Linux Terminal, e.g., ```bash model_build.sh```.